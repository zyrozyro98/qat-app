const express = require('express');
const session = require('express-session');
const bcrypt = require('bcryptjs');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');
const multer = require('multer');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
const { Server } = require('socket.io');
const http = require('http');
const nodemailer = require('nodemailer');
const xlsx = require('xlsx');

const app = express();
const server = http.createServer(app);
const io = new Server(server);

// ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ูุงููุณุงุฆุท
app.use(helmet({ contentSecurityPolicy: false }));
app.use(compression());
app.use(cors({ origin: true, credentials: true }));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(express.static(path.join(__dirname, 'public')));

const limiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 100 });
app.use('/api/', limiter);

// ุงูุฌูุณุงุช (ุงุณุชุจุฏูุช MemoryStore ุจู session.MemoryStore ูุชุฌูุจ ุงูุชุญุฐูุฑ)
const sessionMiddleware = session({
    secret: process.env.SESSION_SECRET || crypto.randomBytes(64).toString('hex'),
    resave: false,
    saveUninitialized: false,
    cookie: { secure: false, httpOnly: true, maxAge: 24 * 60 * 60 * 1000 }
});
app.use(sessionMiddleware);

// Middleware ูููุตุงุฏูุฉ
const requireAuth = (req, res, next) => {
    if (!req.session.userId) return res.status(401).json({ error: 'ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู' });
    next();
};
const requireAdmin = (req, res, next) => {
    if (!req.session.userId || req.session.role !== 'admin') return res.status(403).json({ error: 'ุตูุงุญูุฉ ูุฑููุถุฉ' });
    next();
};
const requireSeller = (req, res, next) => {
    if (!req.session.userId || req.session.role !== 'seller') return res.status(403).json({ error: 'ูุฌุจ ุฃู ุชููู ุจุงุฆุนุงู' });
    next();
};
const requireBuyer = (req, res, next) => {
    if (!req.session.userId || req.session.role !== 'buyer') return res.status(403).json({ error: 'ูุฌุจ ุฃู ุชููู ูุดุชุฑูุงู' });
    next();
};

// ูุงุนุฏุฉ ุงูุจูุงูุงุช
const db = require('./database');

// WebSocket ููุฅุดุนุงุฑุงุช
io.on('connection', (socket) => {
    socket.on('joinRoom', (userId) => socket.join(`user_${userId}`));
});

// ============ API Routes ============

// 1. ุงููุตุงุฏูุฉ
app.post('/api/register', async (req, res) => {
    try {
        const { name, email, phone, password, role, storeName, vehicleType } = req.body;
        if (!name || !email || !phone || !password || !role) {
            return res.status(400).json({ error: 'ุฌููุน ุงูุญููู ูุทููุจุฉ' });
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู (ุงุณุชุฎุฏู prepared statement)
        const existingUser = await new Promise((resolve, reject) => {
            db.get('SELECT id FROM users WHERE email = ? OR phone = ?', [email, phone], (err, row) => {
                if (err) reject(err);
                else resolve(row);
            });
        });
        if (existingUser) return res.status(400).json({ error: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ุฑูู ุงููุงุชู ูุณุชุฎุฏู ุจุงููุนู' });

        const hashedPassword = await bcrypt.hash(password, 12);
        const result = await new Promise((resolve, reject) => {
            db.run('INSERT INTO users (name, email, phone, password, role, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)',
                [name, email, phone, hashedPassword, role, 'active', new Date().toISOString()],
                function (err) {
                    if (err) reject(err);
                    else resolve(this);
                });
        });

        const userId = result.lastID;
        await new Promise((resolve, reject) => {
            db.run('INSERT INTO wallets (user_id, balance, created_at) VALUES (?, ?, ?)',
                [userId, 0, new Date().toISOString()], (err) => err ? reject(err) : resolve());
        });

        if (role === 'seller' && storeName) {
            await new Promise((resolve, reject) => {
                db.run('INSERT INTO sellers (user_id, store_name, rating, total_sales, created_at) VALUES (?, ?, ?, ?, ?)',
                    [userId, storeName, 0, 0, new Date().toISOString()], (err) => err ? reject(err) : resolve());
            });
        }

        if (role === 'driver' && vehicleType) {
            await new Promise((resolve, reject) => {
                db.run('INSERT INTO drivers (user_id, vehicle_type, rating, status, created_at) VALUES (?, ?, ?, ?, ?)',
                    [userId, vehicleType, 0, 'available', new Date().toISOString()], (err) => err ? reject(err) : resolve());
            });
        }

        req.session.userId = userId;
        req.session.role = role;
        req.session.userEmail = email;

        res.json({ success: true, message: 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ', user: { id: userId, name, email, phone, role } });
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุชุณุฌูู:', error);
        res.status(500).json({ error: 'ุฎุทุฃ ูู ุงูุฎุงุฏู' });
    }
});

app.post('/api/login', async (req, res) => {
    try {
        const { email, password } = req.body;
        const user = await new Promise((resolve, reject) => {
            db.get('SELECT * FROM users WHERE email = ? AND status = ?', [email, 'active'], (err, row) => {
                if (err) reject(err);
                else resolve(row);
            });
        });

        if (!user) return res.status(401).json({ error: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ' });
        const validPassword = await bcrypt.compare(password, user.password);
        if (!validPassword) return res.status(401).json({ error: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ' });

        req.session.userId = user.id;
        req.session.role = user.role;
        req.session.userEmail = user.email;

        res.json({
            success: true,
            message: 'ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ',
            user: { id: user.id, name: user.name, email: user.email, phone: user.phone, role: user.role, avatar: user.avatar }
        });
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู:', error);
        res.status(500).json({ error: 'ุฎุทุฃ ูู ุงูุฎุงุฏู' });
    }
});

app.post('/api/logout', (req, res) => {
    req.session.destroy();
    res.json({ success: true, message: 'ุชู ุชุณุฌูู ุงูุฎุฑูุฌ' });
});

// 2. ุงูุฃุณูุงู ูุงููุบุงุณู (ูููุฏูุฑ)
app.post('/api/admin/markets', requireAdmin, async (req, res) => {
    try {
        const { name, location, description, phone, manager } = req.body;
        await new Promise((resolve, reject) => {
            db.run('INSERT INTO markets (name, location, description, phone, manager, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)',
                [name, location, description, phone, manager, 'active', new Date().toISOString()],
                function (err) { err ? reject(err) : resolve(this); });
        });
        io.emit('marketAdded', { name });
        res.json({ success: true, message: 'ุชู ุฅุถุงูุฉ ุงูุณูู' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// 3. ุงูููุชุฌุงุช
app.get('/api/products', async (req, res) => {
    try {
        const { category, market_id, seller_id, min_price, max_price, search } = req.query;
        let query = `
            SELECT p.*, u.name as seller_name, u.avatar as seller_avatar,
                   s.store_name, s.rating as seller_rating,
                   m.name as market_name,
                   (SELECT AVG(rating) FROM reviews WHERE product_id = p.id) as avg_rating,
                   (SELECT COUNT(*) FROM reviews WHERE product_id = p.id) as review_count
            FROM products p
            LEFT JOIN users u ON p.seller_id = u.id
            LEFT JOIN sellers s ON p.seller_id = s.user_id
            LEFT JOIN markets m ON p.market_id = m.id
            WHERE p.status = 'active'
        `;
        const params = [];
        if (category) { query += ' AND p.category = ?'; params.push(category); }
        if (market_id) { query += ' AND p.market_id = ?'; params.push(market_id); }
        if (seller_id) { query += ' AND p.seller_id = ?'; params.push(seller_id); }
        if (min_price) { query += ' AND p.price >= ?'; params.push(min_price); }
        if (max_price) { query += ' AND p.price <= ?'; params.push(max_price); }
        if (search) { query += ' AND (p.name LIKE ? OR p.description LIKE ?)'; params.push(`%${search}%`, `%${search}%`); }
        query += ' ORDER BY p.created_at DESC';

        const products = await new Promise((resolve, reject) => {
            db.all(query, params, (err, rows) => err ? reject(err) : resolve(rows));
        });
        res.json({ success: true, products });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ... (ูุชู ุชุฎุตูุต ุงุณุชููุงู ุจุงูู ููุงุท ุงู API ุงูุฑุฆูุณูุฉ ุญุณุจ ุงูููู ุงูุฃุตููุ ูุน ุชุตุญูุญ ุฌููุน ุงุณุชุนูุงูุงุช SQL)

// ููุทุฉ ููุงูุฉ ููุชุญูู ูู ุตุญุฉ ุงูุฎุงุฏู
app.get('/api/health', (req, res) => {
    res.json({ status: 'OK', message: 'ุงูุฎุงุฏู ูุนูู ุจุดูู ุตุญูุญ', timestamp: new Date().toISOString() });
});

// ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ูุนุงูุฌ ุงูุฃุฎุทุงุก ุงูุนุงู
app.use((err, req, res, next) => {
    console.error('ุฎุทุฃ ุบูุฑ ูุชููุน:', err);
    res.status(500).json({ error: 'ุญุฏุซ ุฎุทุฃ ุฏุงุฎูู ูู ุงูุฎุงุฏู' });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`โ ุงูุฎุงุฏู ูุนูู ุนูู ุงููููุฐ ${PORT}`);
    console.log(`๐ ูููู ุงููุตูู ููุชุทุจูู ุนุจุฑ: https://qat-app.onrender.com`);
});
