<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة تحكم المدير - تطبيق قات PRO</title>
<style>
:root {
    --primary: #1a237e;
        --primary-dark: #0d1b7a;
--secondary: #4a148c;
--success: #2e7d32;
--warning: #ff8f00;
--danger: #c62828;
--info: #0277bd;
}
/* تنسيقات كاملة للوحة التحكم */
</style>
</head>
<body>
<div id="adminApp">
<!-- شريط التنقل العلوي -->
<nav class="admin-nav">
<div class="nav-brand">
<i class="fas fa-crown"></i>
<span>لوحة تحكم المدير</span>
</div>
<div class="nav-menu">
<a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> الرئيسية</a>
<a href="#users"><i class="fas fa-users"></i> المستخدمين</a>
<a href="#sellers"><i class="fas fa-store"></i> البائعين</a>
<a href="#markets"><i class="fas fa-shopping-cart"></i> الأسواق</a>
<a href="#coupons"><i class="fas fa-gift"></i> الكوبونات</a>
<a href="#reports"><i class="fas fa-chart-bar"></i> التقارير</a>
<a href="#settings"><i class="fas fa-cog"></i> الإعدادات</a>
</div>
</nav>

<!-- المحتوى الرئيسي -->
<main class="admin-content">
<!-- قسم لوحة التحكم -->
<section id="dashboard" class="admin-section active">
<h1><i class="fas fa-tachometer-alt"></i> لوحة التحكم الرئيسية</h1>
<div class="stats-grid">
<!-- إحصائيات النظام -->
</div>
<!-- المخططات البيانية -->
<!-- آخر الأنشطة -->
</section>

<!-- قسم إدارة المستخدمين -->
<section id="users" class="admin-section">
<h1><i class="fas fa-users"></i> إدارة المستخدمين</h1>
<div class="filters">
<select id="userRoleFilter">
<option value="">جميع الأدوار</option>
<option value="buyer">مشتري (مولعي)</option>
<option value="seller">بائع (مقوت)</option>
<option value="driver">مندوب توصيل</option>
</select>
<select id="userStatusFilter">
<option value="">جميع الحالات</option>
<option value="pending">في انتظار التفعيل</option>
<option value="active">نشط</option>
<option value="suspended">موقوف</option>
</select>
<input type="text" placeholder="بحث بالاسم أو الهاتف">
<button class="btn btn-primary" onclick="exportUsers()">
<i class="fas fa-file-export"></i> تصدير Excel
</button>
</div>
<div class="table-responsive">
<table class="admin-table">
<thead>
<tr>
<th>#</th>
<th>الصورة</th>
<th>الاسم الرباعي</th>
<th>رقم الهاتف</th>
<th>رقم البطاقة</th>
<th>نوع الحساب</th>
<th>الحالة</th>
<th>التاريخ</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody id="usersTableBody">
<!-- سيتم تعبئتها بـ JavaScript -->
</tbody>
</table>
</div>
</section>

<!-- قسم إدارة البائعين -->
<section id="sellers" class="admin-section">
<h1><i class="fas fa-store"></i> إدارة البائعين</h1>
<div class="verification-panel">
<h3>طلبات التحقق المعلقة</h3>
<div id="pendingVerifications">
<!-- طلبات التحقق -->
</div>
</div>
</section>

<!-- قسم إدارة الأسواق -->
<section id="markets" class="admin-section">
<h1><i class="fas fa-shopping-cart"></i> إدارة الأسواق</h1>
<button class="btn btn-success" onclick="showAddMarketModal()">
<i class="fas fa-plus"></i> إضافة سوق جديد
</button>
<div class="markets-grid">
<!-- قائمة الأسواق -->
</div>
</section>

<!-- قسم إدارة الكوبونات -->
<section id="coupons" class="admin-section">
<h1><i class="fas fa-gift"></i> إدارة كوبونات الهدايا والخصم</h1>
<div class="coupon-types">
<button class="btn btn-primary" onclick="showCreateCouponModal('gift')">
<i class="fas fa-gift"></i> كوبون هدية
</button>
<button class="btn btn-success" onclick="showCreateCouponModal('discount')">
<i class="fas fa-percentage"></i> كوبون خصم
</button>
<button class="btn btn-info" onclick="showCreateCouponModal('shipping')">
<i class="fas fa-shipping-fast"></i> كوبون توصيل مجاني
</button>
</div>
<div class="coupons-list">
<!-- قائمة الكوبونات -->
</div>
</section>

<!-- قسم إنشاء الكوبون -->
<div class="modal" id="createCouponModal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h3><i class="fas fa-gift"></i> إنشاء كوبون جديد</h3>
<button class="modal-close" onclick="closeModal('createCouponModal')">×</button>
</div>
<div class="modal-body">
<form id="couponForm">
<div class="form-row">
<div class="form-group">
<label>نوع الكوبون</label>
<select id="couponType" class="form-control" required>
<option value="">اختر النوع</option>
<option value="amount">قيمة ثابتة</option>
<option value="percentage">نسبة مئوية</option>
<option value="free_shipping">توصيل مجاني</option>
</select>
</div>
<div class="form-group">
<label>القيمة</label>
<input type="number" id="couponValue" class="form-control" placeholder="القيمة" required>
</div>
</div>

<div class="form-group">
<label>كود الكوبون</label>
<div class="input-group">
<input type="text" id="couponCode" class="form-control" placeholder="كود الكوبون" required>
<button type="button" class="btn btn-secondary" onclick="generateCouponCode()">
<i class="fas fa-sync"></i> توليد عشوائي
</button>
</div>
</div>

<div class="form-group">
<label>الفئة المستهدفة</label>
<select id="targetType" class="form-control" required onchange="showTargetCriteria()">
<option value="all">جميع المستخدمين</option>
<option value="specific_users">مستخدمين محددين</option>
<option value="by_balance">حسب الرصيد</option>
<option value="by_orders">حسب عدد الطلبات</option>
<option value="new_users">المستخدمين الجدد</option>
</select>
</div>

<div id="targetCriteriaSection" style="display: none;">
<!-- معايير الاستهداف -->
<div id="byBalanceCriteria" style="display: none;">
<label>الحد الأدنى للرصيد</label>
<input type="number" id="minBalance" class="form-control" placeholder="أدنى رصيد">
</div>
<div id="byOrdersCriteria" style="display: none;">
<label>الحد الأدنى للطلبات الناجحة</label>
<input type="number" id="minOrders" class="form-control" placeholder="أدنى عدد طلبات">
</div>
<div id="specificUsersCriteria" style="display: none;">
<label>اختيار مستخدمين محددين</label>
<select id="selectedUsers" class="form-control" multiple style="height: 150px;">
<!-- سيتم تعبئتها بالمستخدمين -->
</select>
</div>
</div>

<div class="form-row">
<div class="form-group">
<label>تاريخ البداية</label>
<input type="datetime-local" id="validFrom" class="form-control">
</div>
<div class="form-group">
<label>تاريخ النهاية</label>
<input type="datetime-local" id="validUntil" class="form-control">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label>الحد الأقصى للاستخدام</label>
<input type="number" id="usageLimit" class="form-control" placeholder="لا نهائي إذا ترك فارغاً">
</div>
<div class="form-group">
<label>أدنى قيمة طلب</label>
<input type="number" id="minOrderAmount" class="form-control" placeholder="أدنى قيمة طلب">
</div>
</div>

<div class="form-group">
<label>ملاحظات</label>
<textarea id="couponNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية"></textarea>
</div>

<button type="submit" class="btn btn-primary btn-block">
<i class="fas fa-save"></i> حفظ الكوبون
</button>
</form>
</div>
</div>
</div>
</main>
</div>

<script>
// كود JavaScript الكامل للوحة تحكم المدير
class AdminDashboard {
constructor() {
this.currentUser = null;
this.stats = {};
this.init();
}

async init() {
await this.checkAuth();
await this.loadStats();
this.setupEventListeners();
this.loadUsers();
this.loadMarkets();
this.loadCoupons();
}

async checkAuth() {
// التحقق من هوية المدير
const token = localStorage.getItem('admin_token');
if (!token) {
window.location.href = '/admin-login.html';
return;
}

try {
const response = await fetch('/api/admin/me', {
headers: { 'Authorization': `Bearer ${token}` }
});
if (!response.ok) throw new Error('غير مصرح');
this.currentUser = await response.json();
} catch (error) {
window.location.href = '/admin-login.html';
}
}

async loadStats() {
try {
const response = await fetch('/api/admin/stats');
this.stats = await response.json();
this.updateDashboard();
} catch (error) {
console.error('خطأ في تحميل الإحصائيات:', error);
}
}

async loadUsers(filters = {}) {
const query = new URLSearchParams(filters).toString();
const response = await fetch(`/api/admin/users?${query}`);
const users = await response.json();
this.renderUsersTable(users);
}

async loadMarkets() {
const response = await fetch('/api/admin/markets');
const markets = await response.json();
this.renderMarkets(markets);
}

async loadCoupons() {
const response = await fetch('/api/admin/coupons');
const coupons = await response.json();
this.renderCoupons(coupons);
}

renderUsersTable(users) {
const tbody = document.getElementById('usersTableBody');
tbody.innerHTML = users.map(user => `
                  <tr>
                  <td>${user.id}</td>
                                  <td>
${user.avatar ?
`<img src="${user.avatar}" class="user-avatar">` :
    `<div class="avatar-placeholder">${user.full_name.charAt(0)}</div>`
}
</td>
  <td>
  <strong>${user.full_name}</strong><br>
                             <small>${user.email}</small>
                                                   </td>
                                                     <td>${user.phone}</td>
                                                                        <td>${user.national_id}</td>
                                                                                                 <td>
                                                                                                 <span class="badge badge-${this.getRoleClass(user.role)}">
${this.getRoleText(user.role)}
</span>
</td>
<td>
<span class="badge badge-${this.getStatusClass(user.status)}">
${this.getStatusText(user.status)}
</span>
</td>
<td>${new Date(user.created_at).toLocaleDateString('ar-SA')}</td>
<td>
<button class="btn btn-sm btn-info" onclick="viewUserDetails(${user.id})">
<i class="fas fa-eye"></i>
</button>
${user.status === 'pending' ? `
                              <button class="btn btn-sm btn-success" onclick="approveUser(${user.id})">
<i class="fas fa-check"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="rejectUser(${user.id})">
<i class="fas fa-times"></i>
</button>
` : ''}
<button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">
<i class="fas fa-edit"></i>
</button>
</td>
</tr>
`).join('');
}

getRoleClass(role) {
    const classes = {
'admin': 'danger',
'seller': 'warning',
'buyer': 'info',
'driver': 'success'
};
return classes[role] || 'secondary';
}

getRoleText(role) {
const texts = {
    'admin': 'مدير',
    'seller': 'بائع',
    'buyer': 'مشتري',
    'driver': 'مندوب'
};
return texts[role] || role;
}

getStatusClass(status) {
const classes = {
    'active': 'success',
    'pending': 'warning',
    'suspended': 'danger'
};
return classes[status] || 'secondary';
}

getStatusText(status) {
const texts = {
    'active': 'نشط',
    'pending': 'في انتظار التفعيل',
    'suspended': 'موقوف'
};
return texts[status] || status;
}

async createCoupon(data) {
try {
const response = await fetch('/api/admin/coupons', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(data)
});
if (response.ok) {
alert('تم إنشاء الكوبون بنجاح');
this.loadCoupons();
closeModal('createCouponModal');
}
} catch (error) {
console.error('خطأ في إنشاء الكوبون:', error);
alert('حدث خطأ في إنشاء الكوبون');
}
}

setupEventListeners() {
// إعداد مستمعي الأحداث
document.getElementById('couponForm').addEventListener('submit', (e) => {
    e.preventDefault();
this.handleCreateCoupon();
});
}

async handleCreateCoupon() {
const formData = {
    code: document.getElementById('couponCode').value,
    type: document.getElementById('couponType').value,
    value: parseFloat(document.getElementById('couponValue').value),
    target_type: document.getElementById('targetType').value,
    target_criteria: this.getTargetCriteria(),
    min_order_amount: parseFloat(document.getElementById('minOrderAmount').value) || 0,
    usage_limit: parseInt(document.getElementById('usageLimit').value) || null,
    valid_from: document.getElementById('validFrom').value,
    valid_until: document.getElementById('validUntil').value,
    notes: document.getElementById('couponNotes').value
};

await this.createCoupon(formData);
}

getTargetCriteria() {
const targetType = document.getElementById('targetType').value;
let criteria = {};

switch(targetType) {
    case 'by_balance':
criteria.min_balance = parseFloat(document.getElementById('minBalance').value) || 0;
break;
case 'by_orders':
criteria.min_orders = parseInt(document.getElementById('minOrders').value) || 0;
break;
case 'specific_users':
const selectedUsers = Array.from(document.getElementById('selectedUsers').selectedOptions)
.map(option => option.value);
criteria.user_ids = selectedUsers;
break;
}

return JSON.stringify(criteria);
}
}

// دوال مساعدة عامة
function generateCouponCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
let code = '';
for (let i = 0; i < 8; i++) {
code += chars.charAt(Math.floor(Math.random() * chars.length));
if (i === 3) code += '-';
}
document.getElementById('couponCode').value = `QAT-${code}`;
}

function showTargetCriteria() {
    const targetType = document.getElementById('targetType').value;
const section = document.getElementById('targetCriteriaSection');

// إخفاء جميع المعايير
document.querySelectorAll('#targetCriteriaSection > div').forEach(div => {
    div.style.display = 'none';
});

// إظهار المعايير المحددة
if (targetType === 'all' || targetType === 'new_users') {
section.style.display = 'none';
} else {
section.style.display = 'block';
document.getElementById(`${targetType}Criteria`).style.display = 'block';
}
}

// تهيئة التطبيق
const adminApp = new AdminDashboard();
</script>
  </body>
    </html>
