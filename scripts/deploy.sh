#!/bin/bash

# ุณูุฑูุจุช ูุดุฑ ุชุทุจูู ูุงุช PRO
# ุงููุคูู: ููุณู ูุญูุฏ ุนูู ุญููุฏ ุฒููุฑ

set -e

# ุฃููุงู ููุชุณุฌูู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ูุธุงุฆู ูุณุงุนุฏุฉ
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ุงูุชุญูู ูู ุงูุชุจุนูุงุช
check_dependencies() {
    log_info "ุงูุชุญูู ูู ุงูุชุจุนูุงุช..."
    
    local missing_deps=()
    
    # ุงูุชุญูู ูู Docker
    if ! command -v docker &> /dev/null; then
        missing_deps+=("Docker")
    fi
    
    # ุงูุชุญูู ูู Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        missing_deps+=("Docker Compose")
    fi
    
    # ุงูุชุญูู ูู Git
    if ! command -v git &> /dev/null; then
        missing_deps+=("Git")
    fi
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        log_error "ุงูุชุจุนูุงุช ุงูููููุฏุฉ: ${missing_deps[*]}"
        log_info "ูุฑุฌู ุชุซุจูุช ุงูุชุจุนูุงุช ุงูููููุฏุฉ ูุจู ุงููุชุงุจุนุฉ."
        exit 1
    fi
    
    log_success "ุฌููุน ุงูุชุจุนูุงุช ูุซุจุชุฉ."
}

# ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
check_env() {
    log_info "ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ..."
    
    local required_vars=("DOMAIN_NAME" "SSL_EMAIL")
    local missing_vars=()
    
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            missing_vars+=("$var")
        fi
    done
    
    if [ ${#missing_vars[@]} -gt 0 ]; then
        log_error "ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูููููุฏุฉ: ${missing_vars[*]}"
        log_info "ูุฑุฌู ุชุนููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุชุงููุฉ:"
        for var in "${missing_vars[@]}"; do
            log_info "  $var"
        done
        exit 1
    fi
    
    log_success "ุฌููุน ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุถุจูุทุฉ."
}

# ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช
backup_data() {
    log_info "ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุจูุงูุงุช..."
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="backups/deploy_$timestamp"
    
    mkdir -p "$backup_dir"
    
    # ูุณุฎ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    if [ -f "data/database.sqlite" ]; then
        cp "data/database.sqlite" "$backup_dir/"
        log_success "ุชู ูุณุฎ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงุญุชูุงุทูุงู."
    fi
    
    # ูุณุฎ ุงููููุงุช ุงููุญููุฉ
    if [ -d "uploads" ]; then
        cp -r "uploads" "$backup_dir/"
        log_success "ุชู ูุณุฎ ุงููููุงุช ุงููุญููุฉ ุงุญุชูุงุทูุงู."
    fi
    
    # ูุณุฎ ุงูุณุฌูุงุช
    if [ -d "logs" ]; then
        cp -r "logs" "$backup_dir/"
        log_success "ุชู ูุณุฎ ุงูุณุฌูุงุช ุงุญุชูุงุทูุงู."
    fi
    
    # ุถุบุท ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
    tar -czf "$backup_dir.tar.gz" "$backup_dir"
    rm -rf "$backup_dir"
    
    log_success "ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $backup_dir.tar.gz"
}

# ุณุญุจ ุงูุชุญุฏูุซุงุช ูู Git
pull_updates() {
    log_info "ุณุญุจ ุงูุชุญุฏูุซุงุช ูู Git..."
    
    if git pull origin main; then
        log_success "ุชู ุณุญุจ ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ."
    else
        log_error "ูุดู ูู ุณุญุจ ุงูุชุญุฏูุซุงุช."
        exit 1
    fi
}

# ุชุซุจูุช ุงูุชุจุนูุงุช
install_dependencies() {
    log_info "ุชุซุจูุช ุงูุชุจุนูุงุช..."
    
    if npm ci --only=production; then
        log_success "ุชู ุชุซุจูุช ุงูุชุจุนูุงุช ุจูุฌุงุญ."
    else
        log_error "ูุดู ูู ุชุซุจูุช ุงูุชุจุนูุงุช."
        exit 1
    fi
}

# ุจูุงุก ุงูุชุทุจูู
build_app() {
    log_info "ุจูุงุก ุงูุชุทุจูู..."
    
    if docker-compose build; then
        log_success "ุชู ุจูุงุก ุงูุชุทุจูู ุจูุฌุงุญ."
    else
        log_error "ูุดู ูู ุจูุงุก ุงูุชุทุจูู."
        exit 1
    fi
}

# ุฅููุงู ุงูุชุทุจูู ุงููุฏูู
stop_old_app() {
    log_info "ุฅููุงู ุงูุชุทุจูู ุงููุฏูู..."
    
    if docker-compose down; then
        log_success "ุชู ุฅููุงู ุงูุชุทุจูู ุงููุฏูู ุจูุฌุงุญ."
    else
        log_warning "ูู ูุชู ุฅููุงู ุงูุชุทุจูู ุงููุฏููุ ููููุง ูุชุงุจุน."
    fi
}

# ุชุดุบูู ุงูุชุทุจูู ุงูุฌุฏูุฏ
start_new_app() {
    log_info "ุชุดุบูู ุงูุชุทุจูู ุงูุฌุฏูุฏ..."
    
    if docker-compose up -d; then
        log_success "ุชู ุชุดุบูู ุงูุชุทุจูู ุงูุฌุฏูุฏ ุจูุฌุงุญ."
    else
        log_error "ูุดู ูู ุชุดุบูู ุงูุชุทุจูู ุงูุฌุฏูุฏ."
        exit 1
    fi
}

# ุงูุชุญูู ูู ุตุญุฉ ุงูุชุทุจูู
health_check() {
    log_info "ุงูุชุญูู ูู ุตุญุฉ ุงูุชุทุจูู..."
    
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
            log_success "ุงูุชุทุจูู ูุนูู ุจุดูู ุตุญูุญ."
            return 0
        fi
        
        log_info "ูุญุงููุฉ $attempt/$max_attempts: ุงูุชุทุจูู ุบูุฑ ุฌุงูุฒ ุจุนุฏุ ุงูุงูุชุธุงุฑ 5 ุซูุงูู..."
        sleep 5
        ((attempt++))
    done
    
    log_error "ูุดู ูู ุงูุชุญูู ูู ุตุญุฉ ุงูุชุทุจูู ุจุนุฏ $max_attempts ูุญุงููุฉ."
    
    # ุนุฑุถ ุงูุณุฌูุงุช ูููุณุงุนุฏุฉ ูู ุชุตุญูุญ ุงูุฃุฎุทุงุก
    log_info "ุนุฑุถ ุณุฌูุงุช ุงูุชุทุจูู ูููุณุงุนุฏุฉ ูู ุงูุชุตุญูุญ:"
    docker-compose logs app
    
    exit 1
}

# ุชูุธูู ุงูุตูุฑ ุงููุฏููุฉ
cleanup_images() {
    log_info "ุชูุธูู ุงูุตูุฑ ุงููุฏููุฉ..."
    
    # ุญุฐู ุงูุตูุฑ ุงููุนููุฉ
    docker image prune -f
    
    # ุญุฐู ุงูุญุงููุงุช ุงูููููุฉ
    docker container prune -f
    
    log_success "ุชู ุงูุชูุธูู ุจูุฌุงุญ."
}

# ุนุฑุถ ููุฎุต ุงููุดุฑ
show_summary() {
    log_success "โ ุชู ุงูุงูุชูุงุก ูู ุงููุดุฑ ุจูุฌุงุญ!"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "                          ููุฎุต ุงููุดุฑ - ุชุทุจูู ูุงุช PRO"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "๐ ุนููุงู ุงูุชุทุจูู: https://${DOMAIN_NAME}"
    echo "๐ง ุงูุฅุตุฏุงุฑ: 2.0.0"
    echo "๐ ููุช ุงููุดุฑ: $(date)"
    echo ""
    echo "๐ ุญุงูุฉ ุงูุฎุฏูุงุช:"
    docker-compose ps
    echo ""
    echo "๐ ุงูุณุฌูุงุช:"
    echo "  - ุณุฌูุงุช ุงูุชุทุจูู: docker-compose logs app"
    echo "  - ุณุฌูุงุช Nginx: docker-compose logs nginx"
    echo ""
    echo "โก ุฃูุงูุฑ ูููุฏุฉ:"
    echo "  - ุฅุนุงุฏุฉ ุงูุชุดุบูู: docker-compose restart"
    echo "  - ุนุฑุถ ุงูุณุฌูุงุช: docker-compose logs -f"
    echo "  - ุฅููุงู ุงูุชุทุจูู: docker-compose down"
    echo "  - ุชุญุฏูุซ ุงูุชุทุจูู: ./scripts/deploy.sh"
    echo ""
    echo "๐ ููุงุญุธุงุช ุงูุฃูุงู:"
    echo "  - ุชุฃูุฏ ูู ุชุญุฏูุน ุดูุงุฏุงุช SSL ุจุงูุชุธุงู"
    echo "  - ุงุญุชูุธ ุจูุณุฎ ุงุญุชูุงุทูุฉ ููุชุธูุฉ ููุจูุงูุงุช"
    echo "  - ุฑุงูุจ ุณุฌูุงุช ุงููุธุงู ูููุดู ุนู ุฃู ูุดุงุท ูุดุจูู"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
}

# ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
main() {
    log_info "ุจุฏุก ุนูููุฉ ุงููุดุฑ ูุชุทุจูู ูุงุช PRO..."
    echo ""
    
    # ุงูุชุญูู ูู ุงูุชุจุนูุงุช
    check_dependencies
    
    # ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
    check_env
    
    # ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช
    backup_data
    
    # ุณุญุจ ุงูุชุญุฏูุซุงุช
    pull_updates
    
    # ุชุซุจูุช ุงูุชุจุนูุงุช
    install_dependencies
    
    # ุจูุงุก ุงูุชุทุจูู
    build_app
    
    # ุฅููุงู ุงูุชุทุจูู ุงููุฏูู
    stop_old_app
    
    # ุชุดุบูู ุงูุชุทุจูู ุงูุฌุฏูุฏ
    start_new_app
    
    # ุงูุชุญูู ูู ุงูุตุญุฉ
    health_check
    
    # ุงูุชูุธูู
    cleanup_images
    
    # ุนุฑุถ ุงูููุฎุต
    show_summary
}

# ูุนุงูุฌ ุงูุฅุดุงุฑุงุช
cleanup() {
    log_warning "ุชู ููุงุทุนุฉ ุงููุดุฑ."
    log_info "ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ..."
    
    # ูููู ุฅุถุงูุฉ ููุทู ุงูุงุณุชุนุงุฏุฉ ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
    
    exit 1
}

# ุฅุนุฏุงุฏ ูุนุงูุฌ ุงูุฅุดุงุฑุงุช
trap cleanup INT TERM

# ุชุดุบูู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
main
